<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scam Detector - Analyze Suspicious Messages</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8ec 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 700px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
        }

        h1 {
            font-size: 2rem;
            color: #2c3e50;
            margin-bottom: 8px;
        }

        .subtitle {
            color: #666;
            font-size: 1rem;
        }

        .input-section {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
            margin-bottom: 24px;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 10px;
            color: #2c3e50;
        }

        textarea {
            width: 100%;
            height: 180px;
            padding: 14px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 1rem;
            font-family: inherit;
            resize: vertical;
            transition: border-color 0.2s;
        }

        textarea:focus {
            outline: none;
            border-color: #3498db;
        }

        textarea::placeholder {
            color: #aaa;
        }

        .btn-analyze {
            width: 100%;
            padding: 14px 24px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s, transform 0.1s;
            margin-top: 16px;
        }

        .btn-analyze:hover {
            background: #2980b9;
        }

        .btn-analyze:active {
            transform: scale(0.98);
        }

        .btn-analyze:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }

        .results-section {
            display: none;
        }

        .results-section.visible {
            display: block;
        }

        .risk-card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
            margin-bottom: 20px;
            text-align: center;
        }

        .risk-label {
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #666;
            margin-bottom: 12px;
        }

        .risk-score {
            font-size: 2.5rem;
            font-weight: 700;
            padding: 16px 32px;
            border-radius: 50px;
            display: inline-block;
        }

        .risk-score.low {
            background: #d4edda;
            color: #155724;
        }

        .risk-score.medium {
            background: #fff3cd;
            color: #856404;
        }

        .risk-score.high {
            background: #f8d7da;
            color: #721c24;
        }

        .risk-summary {
            margin-top: 16px;
            color: #666;
            font-size: 1rem;
        }

        .flags-card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
        }

        .flags-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .flag-count {
            background: #e74c3c;
            color: white;
            font-size: 0.85rem;
            padding: 2px 10px;
            border-radius: 20px;
        }

        .flag-count.none {
            background: #27ae60;
        }

        .flag-item {
            padding: 14px;
            border-left: 4px solid #e74c3c;
            background: #fef9f9;
            margin-bottom: 12px;
            border-radius: 0 8px 8px 0;
        }

        .flag-item:last-child {
            margin-bottom: 0;
        }

        .flag-category {
            font-weight: 600;
            color: #c0392b;
            font-size: 0.95rem;
            margin-bottom: 4px;
        }

        .flag-explanation {
            color: #555;
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .flag-matches {
            margin-top: 8px;
            font-size: 0.85rem;
            color: #888;
        }

        .flag-matches code {
            background: #fee;
            padding: 2px 6px;
            border-radius: 4px;
            margin-right: 6px;
            color: #c0392b;
        }

        .no-flags {
            text-align: center;
            padding: 30px;
            color: #27ae60;
        }

        .no-flags-icon {
            font-size: 3rem;
            margin-bottom: 12px;
        }

        .clear-btn {
            background: none;
            border: 2px solid #e1e5e9;
            color: #666;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95rem;
            margin-top: 16px;
            transition: all 0.2s;
        }

        .clear-btn:hover {
            border-color: #3498db;
            color: #3498db;
        }

        /* Modal Styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.visible {
            display: flex;
        }

        .modal {
            background: white;
            border-radius: 12px;
            padding: 24px;
            max-width: 450px;
            width: 90%;
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.2);
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .modal-title {
            font-weight: 600;
            color: #2c3e50;
            font-size: 1.1rem;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #888;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }

        .modal-close:hover {
            color: #333;
        }

        .modal-body {
            margin-bottom: 20px;
        }

        .modal-body p {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 16px;
        }

        .settings-link {
            color: #888;
            font-size: 0.85rem;
            cursor: pointer;
            text-decoration: none;
            margin-left: 8px;
        }

        .settings-link:hover {
            color: #3498db;
            text-decoration: underline;
        }

        .api-indicator {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 0.8rem;
            color: #27ae60;
            margin-left: 8px;
        }

        .api-indicator .dot {
            width: 6px;
            height: 6px;
            background: #27ae60;
            border-radius: 50%;
        }

        .footer-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .footer-links {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .api-key-input-group {
            display: flex;
            gap: 10px;
        }

        .api-key-input {
            flex: 1;
            padding: 10px 14px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 0.95rem;
            font-family: monospace;
            transition: border-color 0.2s;
        }

        .api-key-input:focus {
            outline: none;
            border-color: #3498db;
        }

        .api-key-input::placeholder {
            font-family: inherit;
        }

        .btn-save-key {
            padding: 10px 20px;
            background: #27ae60;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn-save-key:hover {
            background: #219a52;
        }

        .api-key-status {
            margin-top: 10px;
            font-size: 0.85rem;
            color: #666;
        }

        .api-key-status.saved {
            color: #27ae60;
        }

        .api-key-status.error {
            color: #e74c3c;
        }

        .divider {
            display: flex;
            align-items: center;
            text-align: center;
            margin: 20px 0;
            color: #888;
            font-size: 0.9rem;
        }

        .divider::before,
        .divider::after {
            content: '';
            flex: 1;
            border-bottom: 1px solid #e1e5e9;
        }

        .divider::before {
            margin-right: 16px;
        }

        .divider::after {
            margin-left: 16px;
        }

        .upload-section {
            margin-top: 16px;
        }

        .btn-upload {
            width: 100%;
            padding: 14px 24px;
            background: #9b59b6;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s, transform 0.1s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-upload:hover {
            background: #8e44ad;
        }

        .btn-upload:active {
            transform: scale(0.98);
        }

        .btn-upload:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }

        .upload-hint {
            text-align: center;
            margin-top: 10px;
            font-size: 0.85rem;
            color: #888;
        }

        .image-preview-container {
            margin-top: 16px;
            display: none;
        }

        .image-preview-container.visible {
            display: block;
        }

        .image-preview-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .image-preview-title {
            font-weight: 600;
            color: #2c3e50;
            font-size: 0.95rem;
        }

        .btn-remove-image {
            background: none;
            border: none;
            color: #e74c3c;
            cursor: pointer;
            font-size: 0.9rem;
            padding: 4px 8px;
        }

        .btn-remove-image:hover {
            text-decoration: underline;
        }

        .image-preview {
            max-width: 100%;
            max-height: 300px;
            border-radius: 8px;
            border: 2px solid #e1e5e9;
            display: block;
        }

        .api-key-warning {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 8px;
            padding: 14px;
            margin-top: 16px;
            color: #856404;
            font-size: 0.9rem;
            display: none;
        }

        .api-key-warning.visible {
            display: block;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .analysis-source {
            font-size: 0.8rem;
            color: #888;
            text-align: center;
            margin-top: 8px;
            font-style: italic;
        }

        footer {
            text-align: center;
            margin-top: 40px;
            color: #888;
            font-size: 0.85rem;
        }

        @media (max-width: 600px) {
            body {
                padding: 16px;
            }

            h1 {
                font-size: 1.6rem;
            }

            .input-section,
            .risk-card,
            .flags-card {
                padding: 18px;
            }

            .risk-score {
                font-size: 2rem;
                padding: 12px 24px;
            }

            textarea {
                height: 150px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Scam Detector</h1>
            <p class="subtitle">Paste a suspicious message or upload a screenshot to analyze for scam indicators</p>
        </header>

        <section class="input-section">
            <label for="message-input">Paste suspicious message here:</label>
            <textarea
                id="message-input"
                placeholder="Paste the email, text message, or DM you want to analyze..."
            ></textarea>
            <button class="btn-analyze" id="analyze-btn">Analyze Message</button>

            <div class="divider">or</div>

            <div class="upload-section">
                <input type="file" id="image-input" accept="image/png,image/jpeg,image/jpg,image/webp,image/gif" style="display: none;">
                <button class="btn-upload" id="upload-btn">
                    <span>&#128247;</span> Upload Screenshot
                </button>
                <p class="upload-hint">Upload a screenshot of a suspicious email, text, or DM (PNG, JPG, WebP, GIF)</p>
            </div>

            <div class="image-preview-container" id="image-preview-container">
                <div class="image-preview-header">
                    <span class="image-preview-title">Screenshot Preview</span>
                    <button class="btn-remove-image" id="remove-image-btn">Remove</button>
                </div>
                <img class="image-preview" id="image-preview" alt="Screenshot preview">
                <div class="image-loading" id="image-loading" style="display: none; text-align: center; padding: 16px; color: #666;">
                    <span class="loading-spinner" style="border-color: rgba(155, 89, 182, 0.3); border-top-color: #9b59b6;"></span>
                    <span style="margin-left: 10px;">Analyzing screenshot...</span>
                </div>
            </div>

            <div class="api-key-warning" id="api-key-warning">
                <strong>API Key Required:</strong> To analyze screenshots, please add your Anthropic API key.
                <a href="#" id="open-settings-warning" style="color: #856404; text-decoration: underline;">Open Settings</a> or
                <a href="https://console.anthropic.com/" target="_blank" rel="noopener" style="color: #856404;">get an API key</a>
            </div>
        </section>

        <section class="results-section" id="results">
            <div class="risk-card">
                <div class="risk-label">Risk Level</div>
                <div class="risk-score" id="risk-score">Low</div>
                <p class="risk-summary" id="risk-summary"></p>
                <p class="analysis-source" id="analysis-source"></p>
            </div>

            <div class="flags-card">
                <div class="flags-title">
                    Red Flags Found
                    <span class="flag-count" id="flag-count">0</span>
                </div>
                <div id="flags-container"></div>
            </div>

            <center>
                <button class="clear-btn" id="clear-btn">Clear & Start Over</button>
            </center>
        </section>

        <footer>
            <div class="footer-content">
                <p>This tool provides general guidance only. When in doubt, verify directly with the official source.</p>
                <div class="footer-links">
                    <a href="#" class="settings-link" id="open-settings">Settings</a>
                    <span class="api-indicator" id="api-indicator" style="display: none;">
                        <span class="dot"></span>
                        API connected
                    </span>
                </div>
            </div>
        </footer>
    </div>

    <!-- Settings Modal -->
    <div class="modal-overlay" id="settings-modal">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title">API Settings</span>
                <button class="modal-close" id="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <p>Enter your Anthropic API key to enable AI-powered scam analysis for both text messages and screenshots.</p>
                <div class="api-key-input-group">
                    <input type="password" class="api-key-input" id="api-key-input" placeholder="sk-ant-api03-...">
                    <button class="btn-save-key" id="save-key-btn">Save</button>
                </div>
                <div class="api-key-status" id="api-key-status"></div>
            </div>
            <p style="font-size: 0.8rem; color: #888; text-align: center;">
                <a href="https://console.anthropic.com/" target="_blank" rel="noopener" style="color: #3498db;">Get an API key from Anthropic</a>
            </p>
        </div>
    </div>

    <script>
        // =====================
        // Claude API Text Analysis
        // =====================
        async function analyzeTextWithClaude(text) {
            const apiKey = getApiKey();
            if (!apiKey) {
                throw new Error('API key is required for text analysis');
            }

            const response = await fetch('https://api.anthropic.com/v1/messages', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'x-api-key': apiKey,
                    'anthropic-version': '2023-06-01',
                    'anthropic-dangerous-direct-browser-access': 'true'
                },
                body: JSON.stringify({
                    model: 'claude-sonnet-4-20250514',
                    max_tokens: 1500,
                    messages: [
                        {
                            role: 'user',
                            content: `Analyze this message for scam/phishing indicators. Evaluate for:

1. Urgency tactics - Artificial time pressure, threats of consequences if you don't act immediately
2. Impersonation attempts - Pretending to be government agencies, banks, tech companies, or other trusted entities
3. Requests for money or personal info - Asking for payments, gift cards, passwords, SSN, bank details
4. Suspicious links - Mentions of clicking links, unusual URLs, shortened links
5. Psychological manipulation - Fear tactics, too-good-to-be-true offers, emotional manipulation, flattery

Message to analyze:
"""
${text}
"""

Respond with a JSON object in this exact format (no markdown, just JSON):
{
  "riskLevel": "low" | "medium" | "high",
  "flags": [
    {
      "category": "Category Name",
      "explanation": "What was found and why it's suspicious"
    }
  ],
  "summary": "Brief overall assessment"
}

Risk level guidelines:
- "low": No scam indicators found, appears to be a normal message
- "medium": 1-2 suspicious elements that warrant caution
- "high": Multiple red flags or clear scam patterns detected

If the text is not a message/communication, respond with:
{"riskLevel": "low", "flags": [], "summary": "This does not appear to be a suspicious message."}`
                        }
                    ]
                })
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.error?.message || `API error: ${response.status}`);
            }

            const data = await response.json();
            const content = data.content[0].text;

            try {
                const cleanContent = content.replace(/```json\n?|\n?```/g, '').trim();
                return JSON.parse(cleanContent);
            } catch (parseError) {
                console.error('Failed to parse Claude response:', content);
                throw new Error('Failed to parse analysis results');
            }
        }

        function getRiskSummary(riskLevel, flagCount) {
            if (riskLevel === 'low') {
                return 'No obvious scam indicators detected. Still, remain cautious with unsolicited messages.';
            } else if (riskLevel === 'medium') {
                return `Found ${flagCount} potential warning sign${flagCount > 1 ? 's' : ''}. Proceed with caution and verify the sender through official channels.`;
            } else {
                return `Found ${flagCount} red flags. This message has multiple characteristics of a scam. Do not respond or click any links.`;
            }
        }

        function displayAnalysisResults(analysis, source = 'text') {
            const resultsSection = document.getElementById('results');
            const riskScoreEl = document.getElementById('risk-score');
            const riskSummaryEl = document.getElementById('risk-summary');
            const analysisSourceEl = document.getElementById('analysis-source');
            const flagCountEl = document.getElementById('flag-count');
            const flagsContainer = document.getElementById('flags-container');

            const riskLevel = analysis.riskLevel || 'low';
            const flags = analysis.flags || [];

            riskScoreEl.textContent = riskLevel.charAt(0).toUpperCase() + riskLevel.slice(1);
            riskScoreEl.className = 'risk-score ' + riskLevel;

            riskSummaryEl.textContent = analysis.summary || getRiskSummary(riskLevel, flags.length);

            if (source === 'image') {
                analysisSourceEl.textContent = 'Analyzed via Claude Vision API';
            } else {
                analysisSourceEl.textContent = 'Analyzed via Claude AI';
            }

            flagCountEl.textContent = flags.length;
            flagCountEl.className = 'flag-count' + (flags.length === 0 ? ' none' : '');

            flagsContainer.innerHTML = '';

            if (flags.length === 0) {
                flagsContainer.innerHTML = `
                    <div class="no-flags">
                        <div class="no-flags-icon">&#10003;</div>
                        <p>No red flags detected in this message.</p>
                    </div>
                `;
            } else {
                for (const flag of flags) {
                    const flagEl = document.createElement('div');
                    flagEl.className = 'flag-item';
                    flagEl.innerHTML = `
                        <div class="flag-category">${escapeHtml(flag.category)}</div>
                        <div class="flag-explanation">${escapeHtml(flag.explanation)}</div>
                    `;
                    flagsContainer.appendChild(flagEl);
                }
            }

            resultsSection.classList.add('visible');
            resultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        document.getElementById('analyze-btn').addEventListener('click', async function() {
            const text = document.getElementById('message-input').value.trim();

            if (!text) {
                alert('Please paste a message to analyze.');
                return;
            }

            const apiKey = getApiKey();
            if (!apiKey) {
                alert('Please add your Anthropic API key in Settings (footer) to analyze messages.');
                document.getElementById('settings-modal').classList.add('visible');
                return;
            }

            const btn = this;
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.innerHTML = '<span class="loading-spinner"></span> Analyzing...';

            try {
                const analysis = await analyzeTextWithClaude(text);
                displayAnalysisResults(analysis, 'text');
            } catch (error) {
                console.error('Analysis error:', error);
                alert('Error analyzing message: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        });

        document.getElementById('clear-btn').addEventListener('click', function() {
            document.getElementById('message-input').value = '';
            document.getElementById('results').classList.remove('visible');
            document.getElementById('message-input').focus();
        });

        document.getElementById('message-input').addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'Enter') {
                document.getElementById('analyze-btn').click();
            }
        });

        // =====================
        // API Key Management
        // =====================
        const API_KEY_STORAGE_KEY = 'scam_detector_anthropic_api_key';

        function getApiKey() {
            return localStorage.getItem(API_KEY_STORAGE_KEY) || '';
        }

        function saveApiKey(key) {
            if (key) {
                localStorage.setItem(API_KEY_STORAGE_KEY, key);
            } else {
                localStorage.removeItem(API_KEY_STORAGE_KEY);
            }
        }

        function updateApiKeyStatus() {
            const statusEl = document.getElementById('api-key-status');
            const inputEl = document.getElementById('api-key-input');
            const indicatorEl = document.getElementById('api-indicator');
            const savedKey = getApiKey();

            if (savedKey) {
                statusEl.textContent = 'API key saved (stored in browser)';
                statusEl.className = 'api-key-status saved';
                inputEl.value = savedKey;
                indicatorEl.style.display = 'inline-flex';
            } else {
                statusEl.textContent = 'No API key saved';
                statusEl.className = 'api-key-status';
                inputEl.value = '';
                indicatorEl.style.display = 'none';
            }
        }

        // Modal functionality
        document.getElementById('open-settings').addEventListener('click', function(e) {
            e.preventDefault();
            document.getElementById('settings-modal').classList.add('visible');
        });

        document.getElementById('close-modal').addEventListener('click', function() {
            document.getElementById('settings-modal').classList.remove('visible');
        });

        document.getElementById('settings-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                this.classList.remove('visible');
            }
        });

        // Save API key
        document.getElementById('save-key-btn').addEventListener('click', function() {
            const inputEl = document.getElementById('api-key-input');
            const statusEl = document.getElementById('api-key-status');
            const key = inputEl.value.trim();

            if (!key) {
                saveApiKey('');
                statusEl.textContent = 'API key removed';
                statusEl.className = 'api-key-status';
                updateApiKeyStatus();
                return;
            }

            if (!key.startsWith('sk-')) {
                statusEl.textContent = 'Invalid API key format. Key should start with "sk-"';
                statusEl.className = 'api-key-status error';
                return;
            }

            saveApiKey(key);
            statusEl.textContent = 'API key saved successfully!';
            statusEl.className = 'api-key-status saved';
            updateApiKeyStatus();
        });

        // Initialize API key status on load
        updateApiKeyStatus();

        // =====================
        // Image Upload and Preview
        // =====================
        let uploadedImageData = null;
        let uploadedImageType = null;

        document.getElementById('upload-btn').addEventListener('click', function() {
            document.getElementById('image-input').click();
        });

        document.getElementById('image-input').addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file) return;

            // Validate file type
            const validTypes = ['image/png', 'image/jpeg', 'image/jpg', 'image/webp', 'image/gif'];
            if (!validTypes.includes(file.type)) {
                alert('Please upload a valid image file (PNG, JPG, WebP, or GIF)');
                return;
            }

            // Validate file size (max 20MB for Claude API)
            if (file.size > 20 * 1024 * 1024) {
                alert('Image file is too large. Maximum size is 20MB.');
                return;
            }

            const reader = new FileReader();
            reader.onload = async function(event) {
                const base64Data = event.target.result;
                uploadedImageData = base64Data.split(',')[1]; // Remove data URL prefix
                uploadedImageType = file.type;

                // Show preview
                document.getElementById('image-preview').src = base64Data;
                document.getElementById('image-preview-container').classList.add('visible');

                // Check for API key
                const apiKey = getApiKey();
                if (!apiKey) {
                    checkApiKeyWarning();
                    return;
                }

                // Auto-analyze the image
                const loadingEl = document.getElementById('image-loading');
                loadingEl.style.display = 'flex';

                try {
                    const analysis = await analyzeImageWithClaude(uploadedImageData, uploadedImageType);
                    displayAnalysisResults(analysis, 'image');
                } catch (error) {
                    console.error('Analysis error:', error);
                    alert('Error analyzing screenshot: ' + error.message);
                } finally {
                    loadingEl.style.display = 'none';
                }
            };
            reader.readAsDataURL(file);
        });

        document.getElementById('remove-image-btn').addEventListener('click', function() {
            uploadedImageData = null;
            uploadedImageType = null;
            document.getElementById('image-input').value = '';
            document.getElementById('image-preview-container').classList.remove('visible');
            document.getElementById('api-key-warning').classList.remove('visible');
            document.getElementById('image-loading').style.display = 'none';
        });

        function checkApiKeyWarning() {
            const warningEl = document.getElementById('api-key-warning');
            if (!getApiKey() && uploadedImageData) {
                warningEl.classList.add('visible');
            } else {
                warningEl.classList.remove('visible');
            }
        }

        // Open settings from warning
        document.getElementById('open-settings-warning').addEventListener('click', function(e) {
            e.preventDefault();
            document.getElementById('settings-modal').classList.add('visible');
        });

        // =====================
        // Claude API Image Analysis
        // =====================
        async function analyzeImageWithClaude(imageBase64, imageType) {
            const apiKey = getApiKey();
            if (!apiKey) {
                throw new Error('API key is required for image analysis');
            }

            const mediaType = imageType || 'image/png';

            const response = await fetch('https://api.anthropic.com/v1/messages', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'x-api-key': apiKey,
                    'anthropic-version': '2023-06-01',
                    'anthropic-dangerous-direct-browser-access': 'true'
                },
                body: JSON.stringify({
                    model: 'claude-sonnet-4-20250514',
                    max_tokens: 1500,
                    messages: [
                        {
                            role: 'user',
                            content: [
                                {
                                    type: 'image',
                                    source: {
                                        type: 'base64',
                                        media_type: mediaType,
                                        data: imageBase64
                                    }
                                },
                                {
                                    type: 'text',
                                    text: `Analyze this screenshot for scam/phishing indicators. Look for:
1. Fake sender addresses or email headers that don't match the claimed sender
2. Impersonation of real companies (banks, Amazon, PayPal, IRS, Microsoft, Apple, Netflix, etc.)
3. Suspicious URLs (misspelled domains, unusual TLDs, URL shorteners)
4. Mismatched or low-quality logos
5. Urgency language or threats (account suspended, act now, etc.)
6. Requests for personal info, passwords, or payment
7. Grammar/spelling errors
8. Too-good-to-be-true offers
9. Unusual sender display names or addresses

Respond with a JSON object in this exact format (no markdown, just JSON):
{
  "riskLevel": "low" | "medium" | "high",
  "flags": [
    {
      "category": "Category Name",
      "explanation": "What was found and why it's suspicious"
    }
  ],
  "summary": "Brief overall assessment"
}

If the image is not a message/email/communication, respond with:
{"riskLevel": "low", "flags": [], "summary": "This image does not appear to be a message or communication."}`
                                }
                            ]
                        }
                    ]
                })
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.error?.message || `API error: ${response.status}`);
            }

            const data = await response.json();
            const content = data.content[0].text;

            // Parse the JSON response
            try {
                // Remove any markdown code blocks if present
                const cleanContent = content.replace(/```json\n?|\n?```/g, '').trim();
                return JSON.parse(cleanContent);
            } catch (parseError) {
                console.error('Failed to parse Claude response:', content);
                throw new Error('Failed to parse analysis results');
            }
        }

        // Update clear button to also clear image
        document.getElementById('clear-btn').addEventListener('click', function() {
            uploadedImageData = null;
            uploadedImageType = null;
            document.getElementById('image-input').value = '';
            document.getElementById('image-preview-container').classList.remove('visible');
            document.getElementById('api-key-warning').classList.remove('visible');
            document.getElementById('image-loading').style.display = 'none';
        });
    </script>
</body>
</html>
