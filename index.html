<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scam Detector - Analyze Suspicious Messages</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8ec 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 700px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
        }

        h1 {
            font-size: 2rem;
            color: #2c3e50;
            margin-bottom: 8px;
        }

        .subtitle {
            color: #666;
            font-size: 1rem;
        }

        .input-section {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
            margin-bottom: 24px;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 10px;
            color: #2c3e50;
        }

        textarea {
            width: 100%;
            height: 180px;
            padding: 14px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 1rem;
            font-family: inherit;
            resize: vertical;
            transition: border-color 0.2s;
        }

        textarea:focus {
            outline: none;
            border-color: #3498db;
        }

        textarea::placeholder {
            color: #aaa;
        }

        .btn-analyze {
            width: 100%;
            padding: 14px 24px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s, transform 0.1s;
            margin-top: 16px;
        }

        .btn-analyze:hover {
            background: #2980b9;
        }

        .btn-analyze:active {
            transform: scale(0.98);
        }

        .btn-analyze:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }

        .results-section {
            display: none;
        }

        .results-section.visible {
            display: block;
        }

        .risk-card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
            margin-bottom: 20px;
            text-align: center;
        }

        .risk-label {
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #666;
            margin-bottom: 12px;
        }

        .risk-score {
            font-size: 2.5rem;
            font-weight: 700;
            padding: 16px 32px;
            border-radius: 50px;
            display: inline-block;
        }

        .risk-score.low {
            background: #d4edda;
            color: #155724;
        }

        .risk-score.medium {
            background: #fff3cd;
            color: #856404;
        }

        .risk-score.high {
            background: #f8d7da;
            color: #721c24;
        }

        .risk-summary {
            margin-top: 16px;
            color: #666;
            font-size: 1rem;
        }

        .flags-card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
        }

        .flags-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .flag-count {
            background: #e74c3c;
            color: white;
            font-size: 0.85rem;
            padding: 2px 10px;
            border-radius: 20px;
        }

        .flag-count.none {
            background: #27ae60;
        }

        .flag-item {
            padding: 14px;
            border-left: 4px solid #e74c3c;
            background: #fef9f9;
            margin-bottom: 12px;
            border-radius: 0 8px 8px 0;
        }

        .flag-item:last-child {
            margin-bottom: 0;
        }

        .flag-category {
            font-weight: 600;
            color: #c0392b;
            font-size: 0.95rem;
            margin-bottom: 4px;
        }

        .flag-explanation {
            color: #555;
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .flag-matches {
            margin-top: 8px;
            font-size: 0.85rem;
            color: #888;
        }

        .flag-matches code {
            background: #fee;
            padding: 2px 6px;
            border-radius: 4px;
            margin-right: 6px;
            color: #c0392b;
        }

        .no-flags {
            text-align: center;
            padding: 30px;
            color: #27ae60;
        }

        .no-flags-icon {
            font-size: 3rem;
            margin-bottom: 12px;
        }

        .clear-btn {
            background: none;
            border: 2px solid #e1e5e9;
            color: #666;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.95rem;
            margin-top: 16px;
            transition: all 0.2s;
        }

        .clear-btn:hover {
            border-color: #3498db;
            color: #3498db;
        }

        .settings-section {
            background: white;
            border-radius: 12px;
            padding: 20px 24px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
            margin-bottom: 24px;
        }

        .settings-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            user-select: none;
        }

        .settings-title {
            font-weight: 600;
            color: #2c3e50;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .settings-toggle {
            color: #666;
            font-size: 0.85rem;
            transition: transform 0.2s;
        }

        .settings-toggle.open {
            transform: rotate(180deg);
        }

        .settings-content {
            display: none;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid #e1e5e9;
        }

        .settings-content.visible {
            display: block;
        }

        .api-key-input-group {
            display: flex;
            gap: 10px;
        }

        .api-key-input {
            flex: 1;
            padding: 10px 14px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 0.95rem;
            font-family: monospace;
            transition: border-color 0.2s;
        }

        .api-key-input:focus {
            outline: none;
            border-color: #3498db;
        }

        .api-key-input::placeholder {
            font-family: inherit;
        }

        .btn-save-key {
            padding: 10px 20px;
            background: #27ae60;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn-save-key:hover {
            background: #219a52;
        }

        .api-key-status {
            margin-top: 10px;
            font-size: 0.85rem;
            color: #666;
        }

        .api-key-status.saved {
            color: #27ae60;
        }

        .api-key-status.error {
            color: #e74c3c;
        }

        .divider {
            display: flex;
            align-items: center;
            text-align: center;
            margin: 20px 0;
            color: #888;
            font-size: 0.9rem;
        }

        .divider::before,
        .divider::after {
            content: '';
            flex: 1;
            border-bottom: 1px solid #e1e5e9;
        }

        .divider::before {
            margin-right: 16px;
        }

        .divider::after {
            margin-left: 16px;
        }

        .upload-section {
            margin-top: 16px;
        }

        .btn-upload {
            width: 100%;
            padding: 14px 24px;
            background: #9b59b6;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s, transform 0.1s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-upload:hover {
            background: #8e44ad;
        }

        .btn-upload:active {
            transform: scale(0.98);
        }

        .btn-upload:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }

        .upload-hint {
            text-align: center;
            margin-top: 10px;
            font-size: 0.85rem;
            color: #888;
        }

        .image-preview-container {
            margin-top: 16px;
            display: none;
        }

        .image-preview-container.visible {
            display: block;
        }

        .image-preview-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .image-preview-title {
            font-weight: 600;
            color: #2c3e50;
            font-size: 0.95rem;
        }

        .btn-remove-image {
            background: none;
            border: none;
            color: #e74c3c;
            cursor: pointer;
            font-size: 0.9rem;
            padding: 4px 8px;
        }

        .btn-remove-image:hover {
            text-decoration: underline;
        }

        .image-preview {
            max-width: 100%;
            max-height: 300px;
            border-radius: 8px;
            border: 2px solid #e1e5e9;
            display: block;
        }

        .btn-analyze-image {
            width: 100%;
            padding: 14px 24px;
            background: #9b59b6;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s, transform 0.1s;
            margin-top: 16px;
        }

        .btn-analyze-image:hover {
            background: #8e44ad;
        }

        .btn-analyze-image:active {
            transform: scale(0.98);
        }

        .btn-analyze-image:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }

        .api-key-warning {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 8px;
            padding: 14px;
            margin-top: 16px;
            color: #856404;
            font-size: 0.9rem;
            display: none;
        }

        .api-key-warning.visible {
            display: block;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .analysis-source {
            font-size: 0.8rem;
            color: #888;
            text-align: center;
            margin-top: 8px;
            font-style: italic;
        }

        footer {
            text-align: center;
            margin-top: 40px;
            color: #888;
            font-size: 0.85rem;
        }

        @media (max-width: 600px) {
            body {
                padding: 16px;
            }

            h1 {
                font-size: 1.6rem;
            }

            .input-section,
            .risk-card,
            .flags-card {
                padding: 18px;
            }

            .risk-score {
                font-size: 2rem;
                padding: 12px 24px;
            }

            textarea {
                height: 150px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Scam Detector</h1>
            <p class="subtitle">Paste a suspicious message or upload a screenshot to analyze for scam indicators</p>
        </header>

        <section class="settings-section">
            <div class="settings-header" id="settings-toggle">
                <span class="settings-title">
                    <span>&#9881;</span> API Settings
                </span>
                <span class="settings-toggle" id="settings-arrow">&#9660;</span>
            </div>
            <div class="settings-content" id="settings-content">
                <p style="margin-bottom: 12px; color: #666; font-size: 0.9rem;">
                    Enter your Anthropic API key to enable screenshot analysis using Claude's vision capability.
                </p>
                <div class="api-key-input-group">
                    <input type="password" class="api-key-input" id="api-key-input" placeholder="sk-ant-api03-...">
                    <button class="btn-save-key" id="save-key-btn">Save</button>
                </div>
                <div class="api-key-status" id="api-key-status"></div>
            </div>
        </section>

        <section class="input-section">
            <label for="message-input">Paste suspicious message here:</label>
            <textarea
                id="message-input"
                placeholder="Paste the email, text message, or DM you want to analyze..."
            ></textarea>
            <button class="btn-analyze" id="analyze-btn">Analyze Message</button>

            <div class="divider">or</div>

            <div class="upload-section">
                <input type="file" id="image-input" accept="image/png,image/jpeg,image/jpg,image/webp,image/gif" style="display: none;">
                <button class="btn-upload" id="upload-btn">
                    <span>&#128247;</span> Upload Screenshot
                </button>
                <p class="upload-hint">Upload a screenshot of a suspicious email, text, or DM (PNG, JPG, WebP, GIF)</p>
            </div>

            <div class="image-preview-container" id="image-preview-container">
                <div class="image-preview-header">
                    <span class="image-preview-title">Screenshot Preview</span>
                    <button class="btn-remove-image" id="remove-image-btn">Remove</button>
                </div>
                <img class="image-preview" id="image-preview" alt="Screenshot preview">
                <button class="btn-analyze-image" id="analyze-image-btn">Analyze Screenshot</button>
            </div>

            <div class="api-key-warning" id="api-key-warning">
                <strong>API Key Required:</strong> To analyze screenshots, you need to add your Anthropic API key in the settings above.
                <a href="https://console.anthropic.com/" target="_blank" rel="noopener">Get an API key</a>
            </div>
        </section>

        <section class="results-section" id="results">
            <div class="risk-card">
                <div class="risk-label">Risk Level</div>
                <div class="risk-score" id="risk-score">Low</div>
                <p class="risk-summary" id="risk-summary"></p>
                <p class="analysis-source" id="analysis-source"></p>
            </div>

            <div class="flags-card">
                <div class="flags-title">
                    Red Flags Found
                    <span class="flag-count" id="flag-count">0</span>
                </div>
                <div id="flags-container"></div>
            </div>

            <center>
                <button class="clear-btn" id="clear-btn">Clear & Start Over</button>
            </center>
        </section>

        <footer>
            <p>This tool provides general guidance only. When in doubt, verify directly with the official source.</p>
        </footer>
    </div>

    <script>
        const redFlagPatterns = [
            {
                category: "Urgency Language",
                patterns: [
                    /\bact\s*now\b/i,
                    /\blimited\s*time\b/i,
                    /\bimmediately\b/i,
                    /\bexpires?\s*today\b/i,
                    /\burgent\b/i,
                    /\bdon'?t\s*delay\b/i,
                    /\btime\s*sensitive\b/i,
                    /\blast\s*chance\b/i,
                    /\bhurry\b/i,
                    /\bonly\s*\d+\s*(hours?|minutes?|days?)\s*(left|remaining)\b/i,
                    /\bexpir(es?|ing)\s*(soon|in\s*\d+)/i,
                    /\bwithin\s*(24|48)\s*hours?\b/i,
                    /\brespond\s*(immediately|now|asap)\b/i
                ],
                explanation: "Scammers create artificial urgency to pressure you into acting without thinking. Legitimate organizations give you time to make decisions."
            },
            {
                category: "Money or Payment Requests",
                patterns: [
                    /\bwire\s*transfer\b/i,
                    /\bgift\s*cards?\b/i,
                    /\bsend\s*(money|funds|payment)\b/i,
                    /\bpay(ment)?\s*(immediately|now|today)\b/i,
                    /\b(western\s*union|moneygram)\b/i,
                    /\bbitcoin\b/i,
                    /\bcrypto(currency)?\b/i,
                    /\bprepaid\s*(card|debit)\b/i,
                    /\bcash\s*app\b/i,
                    /\bzelle\b/i,
                    /\bvenmo\b/i,
                    /\bprocessing\s*fee\b/i,
                    /\btransfer\s*fee\b/i,
                    /\badvance\s*(fee|payment)\b/i
                ],
                explanation: "Requests for money via gift cards, wire transfers, or cryptocurrency are major red flags. These payment methods are nearly impossible to trace or recover."
            },
            {
                category: "Personal Information Requests",
                patterns: [
                    /\bpassword\b/i,
                    /\bssn\b/i,
                    /\bsocial\s*security\b/i,
                    /\bbank\s*(account|details?|information)\b/i,
                    /\brouting\s*number\b/i,
                    /\baccount\s*number\b/i,
                    /\blogin\s*(credentials?|info|details?)\b/i,
                    /\bverify\s*(your\s*)?(identity|account|information)\b/i,
                    /\bconfirm\s*(your\s*)?(identity|account|details?)\b/i,
                    /\bcredit\s*card\s*(number|info|details?)\b/i,
                    /\bpin\s*(number|code)?\b/i,
                    /\bdate\s*of\s*birth\b/i,
                    /\bmother'?s?\s*maiden\s*name\b/i,
                    /\bupdate\s*(your\s*)?(billing|payment)\s*(info|details?)\b/i
                ],
                explanation: "Legitimate companies never ask for passwords, SSN, or full bank details via email or text. This is a classic phishing attempt to steal your identity."
            },
            {
                category: "Too-Good-To-Be-True Offers",
                patterns: [
                    /\blottery\b/i,
                    /\bwinner\b/i,
                    /\byou('ve)?\s*(have\s*)?(won|been\s*selected)\b/i,
                    /\binheritance\b/i,
                    /\bmillion\s*dollars?\b/i,
                    /\bfree\s*money\b/i,
                    /\bclaim\s*(your\s*)?(prize|reward|winnings?)\b/i,
                    /\bcongratulations?\b/i,
                    /\bselected\s*(as\s*a\s*)?(winner|beneficiary)\b/i,
                    /\brandom(ly)?\s*selected\b/i,
                    /\bunclaimed\s*(funds?|money)\b/i,
                    /\bguaranteed\s*(income|return|profit)\b/i,
                    /\brisk\s*free\b/i,
                    /\bdouble\s*your\s*money\b/i
                ],
                explanation: "If it sounds too good to be true, it probably is. You cannot win a lottery you never entered, and strangers don't give away fortunes."
            },
            {
                category: "Suspicious Sender Claims",
                patterns: [
                    /\birs\b/i,
                    /\binternal\s*revenue\b/i,
                    /\btech\s*support\b/i,
                    /\bmicrosoft\s*(support|technician)\b/i,
                    /\bapple\s*support\b/i,
                    /\bnigerian?\s*prince\b/i,
                    /\bbank\s*security\b/i,
                    /\bsecurity\s*department\b/i,
                    /\bfraud\s*department\b/i,
                    /\bfbi\b/i,
                    /\bcustoms\s*(officer|agent)\b/i,
                    /\broyal(ty)?\s*family\b/i,
                    /\bgovernment\s*official\b/i,
                    /\battorney\s*general\b/i,
                    /\bsocial\s*security\s*administration\b/i
                ],
                explanation: "Scammers impersonate trusted authorities to gain your trust. Real government agencies and tech companies don't contact you this way about urgent issues."
            },
            {
                category: "Threatening Language",
                patterns: [
                    /\baccount\s*(will\s*be\s*)?(suspended|closed|terminated)\b/i,
                    /\blegal\s*action\b/i,
                    /\b(arrest|arrested)\b/i,
                    /\bwarrant\b/i,
                    /\bpolice\b/i,
                    /\bjail\b/i,
                    /\bprosecute\b/i,
                    /\blaw\s*enforcement\b/i,
                    /\bseize\s*(your\s*)?(assets?|property)\b/i,
                    /\breport(ed)?\s*to\s*(the\s*)?(authorities|police)\b/i,
                    /\bcriminal\s*charges?\b/i,
                    /\bfines?\s*(of\s*\$?\d+|will\s*be\s*(issued|applied))\b/i,
                    /\bpenalt(y|ies)\b/i,
                    /\bdeport(ation|ed)?\b/i
                ],
                explanation: "Scammers use fear and threats to override your judgment. Legitimate organizations don't threaten arrest or legal action via email or text."
            },
            {
                category: "Unusual Payment Methods",
                patterns: [
                    /\bitunes\s*cards?\b/i,
                    /\bgoogle\s*play\s*cards?\b/i,
                    /\bamazon\s*cards?\b/i,
                    /\bsteam\s*cards?\b/i,
                    /\bpay\s*(with|using|via)\s*(gift\s*cards?|crypto)\b/i,
                    /\bscratch\s*off\s*(the\s*)?code\b/i,
                    /\bread\s*(me\s*)?(the\s*)?numbers?\s*(on\s*(the\s*)?back)?\b/i,
                    /\bredeem(able)?\s*code\b/i,
                    /\buntraceable\b/i,
                    /\banonymous\s*payment\b/i
                ],
                explanation: "No legitimate business or government agency accepts payment via gift cards. This is a tell-tale sign of a scam."
            },
            {
                category: "Spelling and Grammar Errors",
                patterns: [
                    /\bdear\s*(customer|user|friend|beneficiary|sir\/madam)\b/i,
                    /\bkindly\s*(do|provide|send|click|verify)\b/i,
                    /\bdo\s*the\s*needful\b/i,
                    /\brevert\s*back\b/i,
                    /\byour\s*the\s/i,
                    /\bplease\s*to\s/i,
                    /\bwith\s*regards\s*to\s*the\s*above\b/i,
                    /\b(recieve|reciept|transfered|informations|kindest)\b/i
                ],
                explanation: "Poor grammar and unusual phrasing often indicate foreign scam operations. Legitimate companies proofread their communications."
            },
            {
                category: "Suspicious Links or Actions",
                patterns: [
                    /\bclick\s*(here|below|this\s*link)\b/i,
                    /\bverify\s*(now|immediately|your\s*account)\b/i,
                    /\blogin\s*(here|now|immediately)\b/i,
                    /\bupdate\s*(your\s*)?(payment|billing|account)\s*(now|immediately)?\b/i,
                    /\bdownload\s*(this|the)\s*(attachment|file)\b/i,
                    /\benable\s*(macros|content)\b/i,
                    /\bopen\s*(the\s*)?(attached|attachment)\b/i
                ],
                explanation: "Scammers often try to get you to click malicious links or download dangerous files. Never click links in suspicious messages."
            }
        ];

        function analyzeMessage(text) {
            const results = [];

            for (const category of redFlagPatterns) {
                const matches = [];
                for (const pattern of category.patterns) {
                    const match = text.match(pattern);
                    if (match) {
                        matches.push(match[0]);
                    }
                }

                if (matches.length > 0) {
                    results.push({
                        category: category.category,
                        explanation: category.explanation,
                        matches: [...new Set(matches)]
                    });
                }
            }

            return results;
        }

        function calculateRiskLevel(flagCount) {
            if (flagCount === 0) return 'low';
            if (flagCount <= 2) return 'medium';
            return 'high';
        }

        function getRiskSummary(riskLevel, flagCount) {
            if (riskLevel === 'low') {
                return 'No obvious scam indicators detected. Still, remain cautious with unsolicited messages.';
            } else if (riskLevel === 'medium') {
                return `Found ${flagCount} potential warning sign${flagCount > 1 ? 's' : ''}. Proceed with caution and verify the sender through official channels.`;
            } else {
                return `Found ${flagCount} red flags. This message has multiple characteristics of a scam. Do not respond or click any links.`;
            }
        }

        function displayResults(flags, source = 'text') {
            const resultsSection = document.getElementById('results');
            const riskScoreEl = document.getElementById('risk-score');
            const riskSummaryEl = document.getElementById('risk-summary');
            const analysisSourceEl = document.getElementById('analysis-source');
            const flagCountEl = document.getElementById('flag-count');
            const flagsContainer = document.getElementById('flags-container');

            const riskLevel = calculateRiskLevel(flags.length);

            riskScoreEl.textContent = riskLevel.charAt(0).toUpperCase() + riskLevel.slice(1);
            riskScoreEl.className = 'risk-score ' + riskLevel;

            riskSummaryEl.textContent = getRiskSummary(riskLevel, flags.length);

            if (source === 'image') {
                analysisSourceEl.textContent = 'Analyzed via Claude Vision API';
            } else {
                analysisSourceEl.textContent = 'Analyzed via pattern matching';
            }

            flagCountEl.textContent = flags.length;
            flagCountEl.className = 'flag-count' + (flags.length === 0 ? ' none' : '');

            flagsContainer.innerHTML = '';

            if (flags.length === 0) {
                flagsContainer.innerHTML = `
                    <div class="no-flags">
                        <div class="no-flags-icon">&#10003;</div>
                        <p>No red flags detected in this message.</p>
                    </div>
                `;
            } else {
                for (const flag of flags) {
                    const flagEl = document.createElement('div');
                    flagEl.className = 'flag-item';

                    // For image analysis, matches may be descriptive text rather than exact matches
                    const matchesHtml = flag.matches && flag.matches.length > 0
                        ? `<div class="flag-matches">Found: ${flag.matches.map(m => `<code>${escapeHtml(m)}</code>`).join('')}</div>`
                        : '';

                    flagEl.innerHTML = `
                        <div class="flag-category">${escapeHtml(flag.category)}</div>
                        <div class="flag-explanation">${escapeHtml(flag.explanation)}</div>
                        ${matchesHtml}
                    `;
                    flagsContainer.appendChild(flagEl);
                }
            }

            resultsSection.classList.add('visible');
            resultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        document.getElementById('analyze-btn').addEventListener('click', function() {
            const text = document.getElementById('message-input').value.trim();

            if (!text) {
                alert('Please paste a message to analyze.');
                return;
            }

            const flags = analyzeMessage(text);
            displayResults(flags);
        });

        document.getElementById('clear-btn').addEventListener('click', function() {
            document.getElementById('message-input').value = '';
            document.getElementById('results').classList.remove('visible');
            document.getElementById('message-input').focus();
        });

        document.getElementById('message-input').addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'Enter') {
                document.getElementById('analyze-btn').click();
            }
        });

        // =====================
        // API Key Management
        // =====================
        const API_KEY_STORAGE_KEY = 'scam_detector_anthropic_api_key';

        function getApiKey() {
            return localStorage.getItem(API_KEY_STORAGE_KEY) || '';
        }

        function saveApiKey(key) {
            if (key) {
                localStorage.setItem(API_KEY_STORAGE_KEY, key);
            } else {
                localStorage.removeItem(API_KEY_STORAGE_KEY);
            }
        }

        function updateApiKeyStatus() {
            const statusEl = document.getElementById('api-key-status');
            const inputEl = document.getElementById('api-key-input');
            const savedKey = getApiKey();

            if (savedKey) {
                statusEl.textContent = 'API key saved (stored in browser)';
                statusEl.className = 'api-key-status saved';
                inputEl.value = savedKey;
            } else {
                statusEl.textContent = 'No API key saved';
                statusEl.className = 'api-key-status';
                inputEl.value = '';
            }
        }

        // Settings toggle
        document.getElementById('settings-toggle').addEventListener('click', function() {
            const content = document.getElementById('settings-content');
            const arrow = document.getElementById('settings-arrow');
            content.classList.toggle('visible');
            arrow.classList.toggle('open');
        });

        // Save API key
        document.getElementById('save-key-btn').addEventListener('click', function() {
            const inputEl = document.getElementById('api-key-input');
            const statusEl = document.getElementById('api-key-status');
            const key = inputEl.value.trim();

            if (!key) {
                saveApiKey('');
                statusEl.textContent = 'API key removed';
                statusEl.className = 'api-key-status';
                return;
            }

            if (!key.startsWith('sk-')) {
                statusEl.textContent = 'Invalid API key format. Key should start with "sk-"';
                statusEl.className = 'api-key-status error';
                return;
            }

            saveApiKey(key);
            statusEl.textContent = 'API key saved successfully!';
            statusEl.className = 'api-key-status saved';
        });

        // Initialize API key status on load
        updateApiKeyStatus();

        // =====================
        // Image Upload and Preview
        // =====================
        let uploadedImageData = null;
        let uploadedImageType = null;

        document.getElementById('upload-btn').addEventListener('click', function() {
            document.getElementById('image-input').click();
        });

        document.getElementById('image-input').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            // Validate file type
            const validTypes = ['image/png', 'image/jpeg', 'image/jpg', 'image/webp', 'image/gif'];
            if (!validTypes.includes(file.type)) {
                alert('Please upload a valid image file (PNG, JPG, WebP, or GIF)');
                return;
            }

            // Validate file size (max 20MB for Claude API)
            if (file.size > 20 * 1024 * 1024) {
                alert('Image file is too large. Maximum size is 20MB.');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(event) {
                const base64Data = event.target.result;
                uploadedImageData = base64Data.split(',')[1]; // Remove data URL prefix
                uploadedImageType = file.type;

                // Show preview
                document.getElementById('image-preview').src = base64Data;
                document.getElementById('image-preview-container').classList.add('visible');

                // Check for API key and show warning if needed
                checkApiKeyWarning();
            };
            reader.readAsDataURL(file);
        });

        document.getElementById('remove-image-btn').addEventListener('click', function() {
            uploadedImageData = null;
            uploadedImageType = null;
            document.getElementById('image-input').value = '';
            document.getElementById('image-preview-container').classList.remove('visible');
            document.getElementById('api-key-warning').classList.remove('visible');
        });

        function checkApiKeyWarning() {
            const warningEl = document.getElementById('api-key-warning');
            if (!getApiKey() && uploadedImageData) {
                warningEl.classList.add('visible');
            } else {
                warningEl.classList.remove('visible');
            }
        }

        // =====================
        // Claude API Image Analysis
        // =====================
        async function analyzeImageWithClaude(imageBase64, imageType) {
            const apiKey = getApiKey();
            if (!apiKey) {
                throw new Error('API key is required for image analysis');
            }

            const mediaType = imageType || 'image/png';

            const response = await fetch('https://api.anthropic.com/v1/messages', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'x-api-key': apiKey,
                    'anthropic-version': '2023-06-01',
                    'anthropic-dangerous-direct-browser-access': 'true'
                },
                body: JSON.stringify({
                    model: 'claude-sonnet-4-20250514',
                    max_tokens: 1500,
                    messages: [
                        {
                            role: 'user',
                            content: [
                                {
                                    type: 'image',
                                    source: {
                                        type: 'base64',
                                        media_type: mediaType,
                                        data: imageBase64
                                    }
                                },
                                {
                                    type: 'text',
                                    text: `Analyze this screenshot for scam/phishing indicators. Look for:
1. Fake sender addresses or email headers that don't match the claimed sender
2. Impersonation of real companies (banks, Amazon, PayPal, IRS, Microsoft, Apple, Netflix, etc.)
3. Suspicious URLs (misspelled domains, unusual TLDs, URL shorteners)
4. Mismatched or low-quality logos
5. Urgency language or threats (account suspended, act now, etc.)
6. Requests for personal info, passwords, or payment
7. Grammar/spelling errors
8. Too-good-to-be-true offers
9. Unusual sender display names or addresses

Respond with a JSON object in this exact format (no markdown, just JSON):
{
  "riskLevel": "low" | "medium" | "high",
  "flags": [
    {
      "category": "Category Name",
      "explanation": "What was found and why it's suspicious"
    }
  ],
  "summary": "Brief overall assessment"
}

If the image is not a message/email/communication, respond with:
{"riskLevel": "low", "flags": [], "summary": "This image does not appear to be a message or communication."}`
                                }
                            ]
                        }
                    ]
                })
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.error?.message || `API error: ${response.status}`);
            }

            const data = await response.json();
            const content = data.content[0].text;

            // Parse the JSON response
            try {
                // Remove any markdown code blocks if present
                const cleanContent = content.replace(/```json\n?|\n?```/g, '').trim();
                return JSON.parse(cleanContent);
            } catch (parseError) {
                console.error('Failed to parse Claude response:', content);
                throw new Error('Failed to parse analysis results');
            }
        }

        function displayImageAnalysisResults(analysis) {
            const resultsSection = document.getElementById('results');
            const riskScoreEl = document.getElementById('risk-score');
            const riskSummaryEl = document.getElementById('risk-summary');
            const analysisSourceEl = document.getElementById('analysis-source');
            const flagCountEl = document.getElementById('flag-count');
            const flagsContainer = document.getElementById('flags-container');

            const riskLevel = analysis.riskLevel || 'low';

            riskScoreEl.textContent = riskLevel.charAt(0).toUpperCase() + riskLevel.slice(1);
            riskScoreEl.className = 'risk-score ' + riskLevel;

            riskSummaryEl.textContent = analysis.summary || getRiskSummary(riskLevel, analysis.flags?.length || 0);
            analysisSourceEl.textContent = 'Analyzed via Claude Vision API';

            const flags = analysis.flags || [];
            flagCountEl.textContent = flags.length;
            flagCountEl.className = 'flag-count' + (flags.length === 0 ? ' none' : '');

            flagsContainer.innerHTML = '';

            if (flags.length === 0) {
                flagsContainer.innerHTML = `
                    <div class="no-flags">
                        <div class="no-flags-icon">&#10003;</div>
                        <p>No red flags detected in this screenshot.</p>
                    </div>
                `;
            } else {
                for (const flag of flags) {
                    const flagEl = document.createElement('div');
                    flagEl.className = 'flag-item';
                    flagEl.innerHTML = `
                        <div class="flag-category">${escapeHtml(flag.category)}</div>
                        <div class="flag-explanation">${escapeHtml(flag.explanation)}</div>
                    `;
                    flagsContainer.appendChild(flagEl);
                }
            }

            resultsSection.classList.add('visible');
            resultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        document.getElementById('analyze-image-btn').addEventListener('click', async function() {
            if (!uploadedImageData) {
                alert('Please upload an image first.');
                return;
            }

            const apiKey = getApiKey();
            if (!apiKey) {
                alert('Please add your Anthropic API key in the settings above to analyze screenshots.');
                document.getElementById('settings-content').classList.add('visible');
                document.getElementById('settings-arrow').classList.add('open');
                return;
            }

            const btn = this;
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.innerHTML = '<span class="loading-spinner"></span> Analyzing...';

            try {
                const analysis = await analyzeImageWithClaude(uploadedImageData, uploadedImageType);
                displayImageAnalysisResults(analysis);
            } catch (error) {
                console.error('Analysis error:', error);
                alert('Error analyzing image: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        });

        // Update clear button to also clear image
        const originalClearHandler = document.getElementById('clear-btn').onclick;
        document.getElementById('clear-btn').addEventListener('click', function() {
            uploadedImageData = null;
            uploadedImageType = null;
            document.getElementById('image-input').value = '';
            document.getElementById('image-preview-container').classList.remove('visible');
            document.getElementById('api-key-warning').classList.remove('visible');
        });
    </script>
</body>
</html>
